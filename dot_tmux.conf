# Tmux 配置 - Everforest 主题
# ============================================================================

# -- 基础设置 -----------------------------------------------------------------

set -g default-terminal "screen-256color"
set -ga terminal-overrides ",*256col*:Tc"
set -g mouse on
set -sg escape-time 0
set -g history-limit 50000
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g focus-events on

# -- Prefix 键 ----------------------------------------------------------------

unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# -- 分屏 ---------------------------------------------------------------------

bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# Alt+方向键切换窗格
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Alt+hjkl 切换窗格
bind -n M-h select-pane -L
bind -n M-l select-pane -R
bind -n M-k select-pane -U
bind -n M-j select-pane -D

# Alt+数字切换窗口
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5

# 调整窗格大小
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# 重载配置
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# 关闭窗格 (无确认)
bind x kill-pane

# -- 状态栏 (Everforest 配色) -------------------------------------------------

set -g status on
set -g status-position bottom
set -g status-interval 5
set -g status-justify left

# 状态栏整体
set -g status-style "fg=#d3c6aa,bg=#2d353b"

# 左侧 - 会话名 (绿色文字)
set -g status-left-length 30
set -g status-left "#[fg=#a7c080,bold]  #S "

# 右侧 - 系统信息
set -g status-right-length 100
set -g status-right "#{online_status} #[fg=#7fbbb3] #{cpu_percentage} #[fg=#d699b6] #{ram_percentage} #[fg=#dbbc7f]#{battery_icon} #{battery_percentage} #[fg=#859289] %m-%d  %H:%M "

# 窗口列表 - 隐藏
set -g window-status-format ""
set -g window-status-current-format ""

# -- 窗格边框 -----------------------------------------------------------------

set -g pane-border-style "fg=#859289"
set -g pane-active-border-style "fg=#a7c080"
set -g pane-border-lines heavy
set -g pane-border-indicators colour
set -g pane-border-status off

# 活动窗格高亮 (使用 default 保持终端背景透明)
set -g window-style "bg=default"
set -g window-active-style "bg=default"

# -- 消息样式 -----------------------------------------------------------------

set -g message-style "fg=#2d353b,bg=#dbbc7f,bold"
set -g message-command-style "fg=#dbbc7f,bg=#2d353b,bold"

# -- 复制模式 -----------------------------------------------------------------

setw -g mode-style "fg=#2d353b,bg=#dbbc7f,bold"

# 鼠标选中 - 复制并自动退出 (显示提示)
unbind -T copy-mode MouseDragEnd1Pane
unbind -T copy-mode-vi MouseDragEnd1Pane
bind -T copy-mode MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy" \; display-message " Copied!"
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy" \; display-message " Copied!"

# 双击选词
bind -T copy-mode DoubleClick1Pane select-pane \; send-keys -X select-word \; send-keys -X copy-pipe-and-cancel "pbcopy" \; display-message " Copied!"
bind -T copy-mode-vi DoubleClick1Pane select-pane \; send-keys -X select-word \; send-keys -X copy-pipe-and-cancel "pbcopy" \; display-message " Copied!"
bind -T root DoubleClick1Pane select-pane -t = \; if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" "send-keys -M" "copy-mode -H; send-keys -X select-word; send-keys -X copy-pipe-and-cancel pbcopy"

# 三击选行
bind -T copy-mode TripleClick1Pane select-pane \; send-keys -X select-line \; send-keys -X copy-pipe-and-cancel "pbcopy" \; display-message " Copied!"
bind -T copy-mode-vi TripleClick1Pane select-pane \; send-keys -X select-line \; send-keys -X copy-pipe-and-cancel "pbcopy" \; display-message " Copied!"
bind -T root TripleClick1Pane select-pane -t = \; if-shell -F "#{||:#{pane_in_mode},#{mouse_any_flag}}" "send-keys -M" "copy-mode -H; send-keys -X select-line; send-keys -X copy-pipe-and-cancel pbcopy"

# y/Enter 复制并退出
bind -T copy-mode y send-keys -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode Enter send-keys -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "pbcopy"

# q/Escape 退出
bind -T copy-mode q send-keys -X cancel
bind -T copy-mode Escape send-keys -X cancel
bind -T copy-mode-vi q send-keys -X cancel
bind -T copy-mode-vi Escape send-keys -X cancel

# -- 插件 (原生管理) -----------------------------------------------------------
# 安装: git clone <repo> ~/.tmux/plugins/<name>

# tmux-cpu
set -g @cpu_percentage_format "%3.0f%%"
set -g @ram_percentage_format "%3.0f%%"
run-shell -b ~/.tmux/plugins/tmux-cpu/cpu.tmux

# tmux-battery (Nerd Font)
set -g @batt_icon_charge_tier8 ''
set -g @batt_icon_charge_tier7 ''
set -g @batt_icon_charge_tier6 ''
set -g @batt_icon_charge_tier5 ''
set -g @batt_icon_charge_tier4 ''
set -g @batt_icon_charge_tier3 ''
set -g @batt_icon_charge_tier2 ''
set -g @batt_icon_charge_tier1 ''
set -g @batt_icon_status_charged ''
set -g @batt_icon_status_charging ''
set -g @batt_icon_status_discharging ''
run-shell -b ~/.tmux/plugins/tmux-battery/battery.tmux

# tmux-online-status (Nerd Font)
set -g @online_icon ""
set -g @offline_icon ""
run-shell -b ~/.tmux/plugins/tmux-online-status/online_status.tmux

# tmux-resurrect (会话保存/恢复)
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'
set -g @resurrect-processes 'ssh psql mysql sqlite3'
run-shell -b ~/.tmux/plugins/tmux-resurrect/resurrect.tmux

# tmux-continuum (自动保存/恢复)
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'
run-shell -b ~/.tmux/plugins/tmux-continuum/continuum.tmux

# tmux-fzf (模糊搜索)
TMUX_FZF_LAUNCH_KEY="f"
TMUX_FZF_ORDER="session|window|pane|command|keybinding"
run-shell -b ~/.tmux/plugins/tmux-fzf/main.tmux
